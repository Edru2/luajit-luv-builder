name: Build LuaJIT + Luv (Robust)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # --- JOB 1: CHECK FOR UPDATES ---
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      version_info: ${{ steps.get_hashes.outputs.info }}
    steps:
      - name: Get Upstream Commit Hashes
        id: get_hashes
        run: |
          LUV_SHA=$(git ls-remote https://github.com/luvit/luv.git HEAD | awk '{ print $1 }')
          INFO="Built from luvit/luv@${LUV_SHA:0:7}"
          echo "Current Upstream: $INFO"
          echo "info=$INFO" >> $GITHUB_OUTPUT

      - name: Check Previous Release
        id: compare
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_INFO: ${{ steps.get_hashes.outputs.info }}
        run: |
          OLD_BODY=$(gh release view latest --json body -q .body 2>/dev/null || echo "First Run")
          if [[ "$OLD_BODY" == *"$NEW_INFO"* ]]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # --- JOB 2: BUILD ---
  build:
    needs: check-versions
    if: needs.check-versions.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: luajit-linux
            platform: linux
          - os: macos-latest
            asset_name: luajit-mac
            platform: mac
          - os: windows-latest
            asset_name: luajit-win
            platform: windows

    steps:
      - uses: actions/checkout@v4

      # 1. Clone Luv (Recursive to get LuaJIT source)
      - name: Clone luvit/luv
        run: git clone --recursive https://github.com/luvit/luv.git build_work

      # ---------------------------------------------------------
      # STEP A: Build LuaJIT Executable (Native Method)
      # ---------------------------------------------------------
      
      - name: Build LuaJIT Executable (Unix)
        if: matrix.platform != 'windows'
        run: |
          cd build_work/deps/luajit
          # Standard Makefile build - guarantees 'src/luajit' exists
          make -j2
        shell: bash

      - name: Build LuaJIT Executable (Windows)
        if: matrix.platform == 'windows'
        # Windows requires the MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1 
        with:
          arch: x64
      
      - name: Run MSVC Build (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd build_work/deps/luajit/src
          # Standard Batch build - guarantees 'src/luajit.exe' exists
          .\msvcbuild.bat
        shell: cmd

      # ---------------------------------------------------------
      # STEP B: Build Luv Module (CMake Method)
      # ---------------------------------------------------------

      - name: Build Luv (Unix)
        if: matrix.platform != 'windows'
        run: |
          cd build_work
          cmake -S . -B build -DWITH_LUA_ENGINE=LuaJIT -DBUILD_MODULE=ON -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release
        shell: bash

      - name: Build Luv (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd build_work
          cmake -S . -B build -DWITH_LUA_ENGINE=LuaJIT -DBUILD_MODULE=ON -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release
        shell: bash

      # ---------------------------------------------------------
      # STEP C: Package & Zip
      # ---------------------------------------------------------

      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p dist/bin
          mkdir -p dist/lib/lua/5.1
          
          echo "--- Copying Artifacts for ${{ matrix.platform }} ---"

          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            # 1. LuaJIT Executable (From Native Build)
            cp build_work/deps/luajit/src/luajit.exe dist/bin/
            cp build_work/deps/luajit/src/lua51.dll dist/bin/
            
            # 2. Luv DLL (From CMake Build)
            # Find it wherever CMake put it (Release folder or root)
            find build_work/build -name "luv.dll" -exec cp {} dist/lib/lua/5.1/ \;
          else
            # 1. LuaJIT Executable (From Native Build)
            cp build_work/deps/luajit/src/luajit dist/bin/
            
            # 2. Luv SO (From CMake Build)
            # Find luv.so or libluv.so and rename/move it
            find build_work/build -name "luv.so" -exec cp {} dist/lib/lua/5.1/ \; -o -name "libluv.so" -exec cp {} dist/lib/lua/5.1/luv.so \;
            
            # Fix Mac Dylib extension if needed
            find build_work/build -name "libluv.dylib" -exec cp {} dist/lib/lua/5.1/luv.so \;
          fi
          
          echo "--- Contents of dist ---"
          ls -R dist

      - name: Zip Release
        shell: bash
        run: |
          cd dist
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
             Compress-Archive -Path * -DestinationPath ../${{ matrix.asset_name }}.zip
          else
             zip -r ../${{ matrix.asset_name }}.zip .
          fi

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Automated Build
          body: |
            Automated build of LuaJIT + Luv.
            ${{ needs.check-versions.outputs.version_info }}
          files: ${{ matrix.asset_name }}.zip
          draft: false
          prerelease: false
          overwrite: true
