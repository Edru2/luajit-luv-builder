name: Build LuaJIT + Luv (CMake)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # --- JOB 1: CHECK FOR UPDATES ---
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      version_info: ${{ steps.get_hashes.outputs.info }}
    steps:
      - name: Get Upstream Commit Hashes
        id: get_hashes
        run: |
          # We track luvit/luv because it contains LuaJIT as a submodule
          LUV_SHA=$(git ls-remote https://github.com/luvit/luv.git HEAD | awk '{ print $1 }')
          
          INFO="Built from luvit/luv@${LUV_SHA:0:7}"
          echo "Current Upstream: $INFO"
          echo "info=$INFO" >> $GITHUB_OUTPUT

      - name: Check Previous Release
        id: compare
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_INFO: ${{ steps.get_hashes.outputs.info }}
        run: |
          OLD_BODY=$(gh release view latest --json body -q .body 2>/dev/null || echo "First Run")
          if [[ "$OLD_BODY" == *"$NEW_INFO"* ]]; then
            echo "Hashes match. No new versions found."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New versions detected!"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # --- JOB 2: BUILD ---
  build:
    needs: check-versions
    if: needs.check-versions.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: luajit-linux
            platform: linux
          - os: macos-latest
            asset_name: luajit-mac
            platform: mac
          - os: windows-latest
            asset_name: luajit-win
            platform: windows

    steps:
      - uses: actions/checkout@v4

      # 1. Clone Luv (Recursive to get LuaJIT)
      - name: Clone luvit/luv
        run: git clone --recursive https://github.com/luvit/luv.git build_work

      # 2. Configure & Build (Linux/Mac)
      - name: Build (Unix)
        if: matrix.platform != 'windows'
        run: |
          cd build_work
          # Configure CMake to build LuaJIT bundled
          cmake -S . -B build -DWITH_LUA_ENGINE=LuaJIT -DBUILD_MODULE=ON -DBUILD_SHARED_LIBS=OFF
          # Compile
          cmake --build build --config Release
        shell: bash

      # 3. Configure & Build (Windows)
      - name: Build (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd build_work
          # Windows needs specific flags to ensure we get the DLLs right
          cmake -S . -B build -DWITH_LUA_ENGINE=LuaJIT -DBUILD_MODULE=ON -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release
        shell: bash

      # 4. Organize Artifacts (Create the "Tree")
      - name: Package Artifacts
        shell: bash
        run: |
          mkdir -p dist/bin
          mkdir -p dist/lib/lua/5.1
          
          # --- WINDOWS ---
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            # Copy Executable and Lua DLL
            cp build_work/build/deps/luajit/src/luajit.exe dist/bin/
            cp build_work/build/deps/luajit/src/lua51.dll dist/bin/
            # Copy Luv DLL (Renaming if needed)
            # CMake on Windows might output 'luv.dll' or 'libluv.dll' in Release folder
            cp build_work/build/Release/luv.dll dist/lib/lua/5.1/ 2>/dev/null || cp build_work/build/luv.dll dist/lib/lua/5.1/
          fi

          # --- LINUX / MAC ---
          if [[ "${{ matrix.platform }}" != "windows" ]]; then
            # Copy Executable
            cp build_work/build/deps/luajit/src/luajit dist/bin/
            
            # Copy Luv SO (Finding the right name)
            # Mac usually produces luv.so or luv.dylib
            cp build_work/build/luv.so dist/lib/lua/5.1/ 2>/dev/null || cp build_work/build/libluv.so dist/lib/lua/5.1/luv.so
          fi
          
          # Verify structure
          ls -R dist

      # 5. Zip
      - name: Zip Release
        shell: bash
        run: |
          cd dist
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
             Compress-Archive -Path * -DestinationPath ../${{ matrix.asset_name }}.zip
          else
             zip -r ../${{ matrix.asset_name }}.zip .
          fi

      # 6. Upload
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Automated Build
          body: |
            Automated build of LuaJIT + Luv (from source).
            ${{ needs.check-versions.outputs.version_info }}
          files: ${{ matrix.asset_name }}.zip
          draft: false
          prerelease: false
          overwrite: true
